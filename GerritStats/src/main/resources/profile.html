<!DOCTYPE html>
<meta charset="utf-8">
<body>

<script src="res/css-element-queries/ResizeSensor.js"></script>
<script src="res/css-element-queries/ElementQueries.js"></script>
<script src="res/d3.min.js"></script>
<script src="res/jquery.min.js"></script>
<script src="res/jquery.tablesorter.min.js"></script>
<script src="res/bootstrap.min.js"></script>
<script src="res/moment.min.js"></script>
<script src="res/numeral.min.js"></script>
<script src="res/gerritstats.js"></script>
<script src="res/selectedusers.js"></script>
<script src="res/reviewersapprovalsgraph.js"></script>
<script src="overview/overview.js"></script>
<script>
    var userIdentifier = getUrlParameter('user');
</script>
<head>
    <link type="text/css" rel="stylesheet" media="screen" href="res/bootstrap.css" />
    <link type="text/css" rel="stylesheet" media="screen" href="res/style.css" />
    <title id="pageTitleHead"></title>
</head>
<header>
    <table class="filterBox">
        <tr>
            <th><img src="res/ic_branches.png">Branches:</th>
            <td class="filterBoxValue" id="datasetOverviewBranchList"></td>
        </tr>
        <tr>
            <th><span class="glyphicon glyphicon-calendar"></span>From:</th>
            <td class="filterBoxValue" id="datasetOverviewFromDate"></td>
        </tr>
        <tr>
            <th><span class="glyphicon glyphicon-calendar"></span>To:</th>
            <td class="filterBoxValue" id="datasetOverviewToDate"></td>
        </tr>
        <tr>
            <th><span class="glyphicon glyphicon-user"></span>Users in analysis:</th>
            <td class="filterBoxValue" id="datasetOverviewIdentityCount"></td>
        </tr>
    </table>

    <h1 id="pageTitle"></h1>
    <div class="subtitleH1"><span id="pageSubtitle">&nbsp;</span></div>
</header>
<nav>
    <div class="container-fluid">
        <ul id="navBar" class="nav navbar-nav">
            <li role="presentation" class="active" data-type='overall'>Overall</li>
            <li role="presentation" data-type='reviewers'>Reviewers and approvals</li>
            <li role="presentation" data-type='per_month'>Per-month</li>
            <li role="presentation" data-type='iteration'>Iteration</li>
            <li role="presentation" data-type='review_comments'>Review comments</li>
        </ul>
    </div>
</nav>

<content id="content">

    <!--
        TODO: disabled for now. there's little additional value here.
        What about just sticking username to top bar after email?

    <div class="panel">
        <h2>Profile</h2>
        <table>
            <tr><th>Username</th><td id="profileUsername"></td></tr>
            <tr><th>Email</th><td id="profileEmail"></td></tr>
            <tr><th>Aliases</th><td id="profileAliases">&dash;</td></tr>
        </table>
    </div>
    -->

    <div class="panel">
        <h2>Reviews given</h2>
        <div class="numberPanel">
            <div id="reviewCountGivenPlus2" class="value">&dash;</div>
            <div>&nbsp;<div class="title">+1</div></div>
        </div>

        <div class="numberPanel">
            <div id="reviewCountGivenPlus1" class="value">&dash;</div>
            <div>&nbsp;<div class="title">+2</div></div>
        </div>
        <div class="clearFloat"></div>

        <div class="numberPanel">
            <div id="reviewCountGivenMinus1" class="value">&dash;</div>
            <div>&nbsp;<div class="title">-1</div></div>
        </div>

        <div class="numberPanel">
            <div id="reviewCountGivenMinus2" class="value">&dash;</div>
            <div>&nbsp;<div class="title">-2</div></div>
        </div>
    </div>
    <div class="panel">
        <h2>Reviews received</h2>
        <div class="numberPanel">
            <div id="reviewCountReceivedPlus2" class="value">&dash;</div>
            <div>&nbsp;<div class="title">+1</div></div>
        </div>

        <div class="numberPanel">
            <div id="reviewCountReceivedPlus1" class="value">&dash;</div>
            <div>&nbsp;<div class="title">+2</div></div>
        </div>
        <div class="clearFloat"></div>

        <div class="numberPanel">
            <div id="reviewCountReceivedMinus1" class="value">&dash;</div>
            <div>&nbsp;<div class="title">-1</div></div>
        </div>

        <div class="numberPanel">
            <div id="reviewCountReceivedMinus2" class="value">&dash;</div>
            <div>&nbsp;<div class="title">-2</div></div>
        </div>
    </div>

    <div class="panel">
        <h2>Commits</h2>
        <div class="numberPanel">
            <div id="commitsSize" class="value">&dash;</div>
            <div>&nbsp;<div class="title">total commits</div></div>
        </div>
        <div class="numberPanel">
            <div id="addedAsReviewerTo" class="value">&dash;</div>
            <div>&nbsp;<div class="title">added as reviewer</div></div>
        </div>
        <div class="numberPanel">
            <div id="maxPatchSetCount" class="value">&dash;</div>
            <div>&nbsp;<div class="title">max patch set count</div></div>
        </div>

        <div class="clearFloat"></div>

        <div class="numberPanel">
            <div id="commitsAbandoned" class="value">&dash;</div>
            <div>&nbsp;<div class="title">abandoned</div></div>
        </div>
        <div class="numberPanel">
            <div id="commitsInReview" class="value">&dash;</div>
            <div>&nbsp;<div class="title">in review</div></div>
        </div>
        <div class="numberPanel">
            <div id="gitRepoCount" class="value">&dash;</div>
            <div>&nbsp;<div class="title">git repos</div></div>
        </div>
    </div>
    <div class="clearFloat"></div>

    <div class="panel">
        <h2>Adds them as reviewers</h2>
        <table id="addedAsReviewersTable" class="table table-striped">
            <thead>
                <th>Name</th>
                <th class="dataField">times<br>added</th>
                <th class="dataField">reviews<br>given</th>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
                <tr><td colspan="3"></td></tr>
                <tr>
                    <th>Total reviewers added</th>
                    <td colspan="2" id="addsThemAsReviewersCount"></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="panel">
        <h2>Reviewers and approvals</h2>
        <div id="reviewersAndApprovalsSvg">
        </div>
    </div>

    <div class="clearFloat"></div>

    <div class="panelContainer">
        <div class="panel">
            <h2>Reviews by author</h2>
            <div class="numberPanel wide">
                <div id="commentsWritten" class="value">&dash;</div>
                <div>&nbsp;<div class="title">comments written</div></div>
            </div>
            <div class="numberPanel wide">
                <div id="reviewCommentRatio" class="value">&dash;</div>
                <div>&nbsp;<div class="title">comments per review request</div></div>
            </div>

            <div class="clearFloat"></div>

            <table>
                <tr><th>Frequently used words</th></tr>
                <tr><td id="frequentlyUsedWords">&dash;</td></tr>
            </table>
        </div>
        <div class="clearFloat"></div>
        <div class="panel">
            <h2>Received reviews</h2>
            <div class="numberPanel wide">
                <div id="commentsReceived" class="value">&dash;</div>
                <div>&nbsp;<div class="title">comments received</div></div>
            </div>
            <div class="numberPanel wide">
                <div id="receivedCommentRatio" class="value">&dash;</div>
                <div>&nbsp;<div class="title">comments per commit</div></div>
            </div>

            <div class="clearFloat"></div>

            <table>
                <tr><th>Average time in code review</th></tr>
                <tr><td id="averageTimeInCodeReview">&dash;</td></tr>
                <!-- TODO make a bar chart here showing user's time / avg time -->
            </table>
        </div>
    </div>

    <div class="panel">
        <h2>They request reviews</h2>
        <table id="reviewRequestorTable" class="table table-striped">
            <thead>
                <th>Name</th>
                <th class="dataField">times<br>added</th>
                <th class="dataField">reviews<br>given</th>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
                <tr><td colspan="3"></td></tr>
                <tr>
                    <th>Total review requestors</th>
                    <td colspan="2" id="theyAddThisPersonAsReviewerCount"></td>
                </tr>
            </tfoot>
        </table>
    </div>


    <div class="panel">
        <h2>Review comments per day</h2>
        <div id="commentsPerDaySvg">
        </div>
    </div>

    <div class="clearFloat"></div>

    <div class="panel">
        <h2>Commits exceeding <span class="highPatchSetCountThreshold">x</span> patches</h2>
        <p>Only includes commits that were reworked over <span class="highPatchSetCountThreshold"></span> times after the initial review, and then submitted.</p>

        <p id="highPatchSetCountCommitList">
        </p>

        <div id="highPatchSetCountCommitsSvg">
        </div>
    </div>

    <div class="panel">
        <h2>Per-month stats</h2>
        <table class="perMonthStats" id="perMonthStats">
        </table>
    </div>

    <div class="panel">
        <h2>Review comments</h2>
        <p id="reviewComments">
        </p>
    </div>

</content>

<script>
$('nav li').click(function(event) {
    event.preventDefault();
    var navElement = $(this);

    var navType = $(navElement).attr('data-type');
    if (navType === undefined) {
        throw new Error("navType is not defined!");
    }
    navElement.tab('show');

    window.location.href = '#' + navType;
});

var usersInAnalysis = new SelectedUsers(overviewUserdata);

function addCommaSeparatedDataToElement(dataArray, elementQuery, dataRenderer) {
    for (var i = 0; i < dataArray.length; ++i) {
        var data = dataArray[i];
        var renderedData = dataRenderer(data);
        if (renderedData) {
            $(elementQuery).append(renderedData);
            if (i < dataArray.length - 1) {
                $(elementQuery).append(', ');
            }
        }
    }
}

/**
 * Adds a list of reviewers to the element that matches the given element JQuery.
 */
function addReviewerDataToElement(reviewerData, elementJQuery, valueCallback) {
    addCommaSeparatedDataToElement(reviewerData, elementJQuery, function(data) {
        if (usersInAnalysis.isUserSelected(data.identity.identifier)) {
            return '<a href="mailto:' + data.identity.email + '">'
                 + data.identity.email + '</a> (' + valueCallback(data) + ')'
        } else {
            return null;
        }
    });
}

function addReviewerDataToTable(reviewerData, tableJQuery) {
    var tableBody = $(tableJQuery).find('tbody');

    reviewerData.forEach(function(item) {
        tableBody.append('<tr>\
            <td><a href="profile.html?user=' + item.identity.identifier + '">' + getShortPrintableName(item.identity) + '</a></td>\
            <td class="dataField">' + item.approvalData.addedAsReviewerCount + '</td>\
            <td class="dataField">' + item.approvalData.approvalCount + '</td>\
        </tr>');
    });
}

/**
 * Adds all review comments by user to the table at the bottom of the view.
 */
function addReviewCommentsByUser(record, elementQuery) {
    var commits = record.getCommitsWithWrittenCommentsSortedByDate();

    for (var i = 0; i < commits.length; ++i) {
        var commitAndComments = commits[i];
        var commit = commitAndComments.commit;
        var headerCreated = false;

        commit.patchSets.forEach(function(patchSet) {
            // ignore self-reviews and replies
            if (patchSet.author.email == record.identity.email
            || !usersInAnalysis.isUserSelected(patchSet.author.identifier)) {
                return;
            }

            var comments = patchSet.comments;
            comments.forEach(function(comment) {
                if (comment.reviewer.email != record.identity.email) {
                    return;
                }

                if (!headerCreated) {
                    headerCreated = true;
                    var commitCreatedDate = moment(commit.createdOnDate);
                    $(elementQuery).append('<h4><a href="' + commit.url + '">' + commit.url + '</a> (Created: '
                        +  commitCreatedDate.format("YYYY-MM-DD") + ')</h4><ul></ul>');
                }

                var urlForComment = getGerritUrlForComment(commit, patchSet, comment)
                var altText = comment.file + ':' + comment.line;
                $(elementQuery + " ul").last().append('<li><a href="' + urlForComment + '" alt="' + altText + '">'
                    + escapeHtml(comment.message) + '</a></li>');
            });
        });
    }
}

function addHighPatchSetCommits(exceedingCommits) {
    addCommaSeparatedDataToElement(exceedingCommits, '#highPatchSetCountCommitList', function(commit) {
        return '<a href="' + commit.url + '">' + commit.url + '</a> ('
            + userdataScope.getPatchSetCountForKind(commit, 'REWORK') + ')';
    });
}

function addPerMonthStatsYearHeader(year) {
    $('#perMonthStats').append('<tr><th colspan="13" class="monthlyCommitYearTitle">' + year + '</th></tr>\
        <tr><th></th>\
            <th>Jan</th>\
            <th>Feb</th>\
            <th>Mar</th>\
            <th>Apr</th>\
            <th>May</th>\
            <th>Jun</th>\
            <th>Jul</th>\
            <th>Aug</th>\
            <th>Sep</th>\
            <th>Oct</th>\
            <th>Nov</th>\
            <th>Dec</th>\
        </tr>\
        <tr class="commitsSection">\
            <th>Commits</th>\
            <!-- content is added here -->\
        </tr>\
        <tr class="commentsSection">\
            <th>Comments</th>\
            <!-- content is added here -->\
        </tr>\
        <tr class="commitsMoMSection">\
            <th>Commits MoM %</th>\
            <!-- content is added here -->\
        </tr>\
        <tr class="commitsQoQSection">\
            <th>Commits QoQ %</th>\
            <!-- content is added here -->\
        </tr>\
        <tr class="commentsMoMSection">\
            <th>Comments MoM %</th>\
            <!-- content is added here -->\
        </tr>\
        <tr class="commentsQoQSection">\
            <th>Comments QoQ %</th>\
            <!-- content is added here -->\
        </tr>\
    ');
}

function addPerMonthStats(record) {
    var commitTable = record.datedCommitTable;
    var commentTable = record.datedCommentTable;

    var years = record.datedCommitTable.getActiveYears();
    years.forEach(function(year) {
        addPerMonthStatsYearHeader(year);
        for (var month = 1; month <= 12; ++month) {
            var commitCount = commitTable.getPrintableMonthlyItemCount(year, month);
            var commitsMoMChange = commitTable.getDisplayableMonthOnMonthChange(year, month);
            var commitsQoQChange = commitTable.getDisplayableQuarterOnQuarterChange(year, month);

            var commentCount = commentTable.getPrintableMonthlyItemCount(year, month);
            var commentsMoMChange = commentTable.getDisplayableMonthOnMonthChange(year, month);
            var commentsQoQChange = commentTable.getDisplayableQuarterOnQuarterChange(year, month);

            $('#perMonthStats .commitsSection').last().append('<td>' + commitCount + '</td>');
            $('#perMonthStats .commentsSection').last().append('<td>' + commentCount + '</td>');
            $('#perMonthStats .commitsMoMSection').last().append('<td>' + commitsMoMChange + '</td>');
            $('#perMonthStats .commitsQoQSection').last().append('<td>' + commitsQoQChange + '</td>');
            $('#perMonthStats .commentsMoMSection').last().append('<td>' + commentsMoMChange + '</td>');
            $('#perMonthStats .commentsQoQSection').last().append('<td>' + commentsQoQChange + '</td>');
        }
    });
}

function filterForUsersInAnalysis(reviewerData) {
    var result = [];
    reviewerData.forEach(function(item) {
        if (usersInAnalysis.isUserSelected(item.identity)) {
            result.push(item);
        }
    });
    return result;
}

function updateViewFromUserdata() {
    var record = userdata[userIdentifier];
    userdataScope.initializeRecord(record);

    $('#datasetOverviewBranchList').html(datasetOverview.branchList);
    $('#datasetOverviewFromDate').html(moment(datasetOverview.fromDate).format("YYYY-MM-DD"));
    $('#datasetOverviewToDate').html(moment(datasetOverview.toDate).format("YYYY-MM-DD"));
    $('#datasetOverviewIdentityCount').html(usersInAnalysis.getPrintableUserCount());

    $('#pageTitleHead').html("GerritStats: " + record.printableName());
    $('#pageTitle').html(record.shortPrintableName());
    $('#pageSubtitle').html(record.identity.email ? record.identity.email : "&nbsp;");

    $('#profileUsername').html(record.printableUsername());
    $('#profileEmail').html(record.printableEmail());

    $('#commitsSize').html(record.commits.length);
    $('#commentsWritten').html(record.getAllCommentsByUser());
    $('#commentsReceived').html(record.commentsReceived.length);
    $('#receivedCommentRatio').html(record.getReceivedCommentRatio().toFixed(outputConfig.decimalPrecision));
    $('#addedAsReviewerTo').html(record.addedAsReviewerTo.length);
    $('#reviewCommentRatio').html(record.addedAsReviewerTo.length > 0
        ? (record.commentsWritten.length / record.addedAsReviewerTo.length).toFixed(outputConfig.decimalPrecision)
        : "&dash;");
    $('#maxPatchSetCount').html(record.getMaxPatchSetCount());
    $('#reviewCountGivenPlus2').html(record.reviewCountPlus2);
    $('#reviewCountGivenPlus1').html(record.reviewCountPlus1);
    $('#reviewCountGivenMinus1').html(record.reviewCountMinus1);
    $('#reviewCountGivenMinus2').html(record.reviewCountMinus2);
    $('#reviewCountReceivedPlus2').html(record.getReceivedReviewsForScore(2));
    $('#reviewCountReceivedPlus1').html(record.getReceivedReviewsForScore(1));
    $('#reviewCountReceivedMinus1').html(record.getReceivedReviewsForScore(-1));
    $('#reviewCountReceivedMinus2').html(record.getReceivedReviewsForScore(-2));
    $('#averageTimeInCodeReview').html(formatPrintableDuration(record.averageTimeInCodeReview));

    var reviewerData = record.getReviewerDataForOwnCommits();
    reviewerData = filterForUsersInAnalysis(reviewerData);

    addReviewerDataToTable(reviewerData, '#addedAsReviewersTable');
    $('#addsThemAsReviewersCount').html(record.reviewersForOwnCommits.length);
    $('#addedAsReviewersTable').tablesorter();

    addReviewerDataToTable(record.getReviewRequestors(), '#reviewRequestorTable');
    $('#theyAddThisPersonAsReviewerCount').html(record.reviewRequestors.length);
    $('#reviewRequestorTable').tablesorter();

    addReviewCommentsByUser(record, '#reviewComments')

    $('.highPatchSetCountThreshold').html(outputConfig.highPatchSetCountThreshold.toString());

    addHighPatchSetCommits(record.getCommitsWithHighPatchSetCount());
    addPerMonthStats(record);

    var xDomain = [record.getFromDate(), record.getToDate()];
    createFrequencyTable("#commentsPerDaySvg", xDomain, groupReviewCommentsByDate(record.getReviewCommentDates()));
    createFrequencyTable("#highPatchSetCountCommitsSvg", xDomain, record.getDatesForCommitsWithHighPatchSetCount());

    var reviewerApprovalGraph = new ReviewersAndApprovalsGraph('#reviewersAndApprovalsSvg', reviewerData);
    reviewerApprovalGraph.render();
}

/**
  * Processes the data into the following format:
  * [{date: "2015-06-19", "count": 1},
  *  {date: "2015-08-10", "count": 1},
  *  {date: "2015-08-14", "count": 1},
  *  {date: "2015-08-15", "count": 3},
  *   ...
  * ];
*/
function groupReviewCommentsByDate(comments) {
    var frequencies = comments.reduce(function (previousValue, currentValue, index, array) {
        var date = currentValue.date;
        if (typeof previousValue[date] == 'undefined') {
            previousValue[date] = 1;
        } else {
            previousValue[date] += 1;
        }
        return previousValue;
    }, {});

    var data = Object.keys(frequencies).map(function(date, index) {
        return { "date": new Date(date), "count": frequencies[date] };
    });
    data.sort(function(left, right) {
        return (left.date <  right.date) ? -1 : 1;
    });
    return data;
}

function createFrequencyTable(svgId, x_domain, data) {
    var margin = {top: 20, right: 20, bottom: 30, left: 40};
    var width = 800 - margin.left - margin.right;
    var height = 400 - margin.top - margin.bottom;

    var x = d3.time.scale()
        .domain(x_domain)
        .range([0, width]);

    var y = d3.scale.linear()
        .range([height, 0]);

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom")
        .ticks(d3.time.weeks(x_domain[0], x_domain[1]).length)
        .tickFormat(d3.time.format("%W"))

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(10)
        .tickFormat(d3.format("d"))

    var svg = d3.select(svgId).append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    x.domain(x_domain);
    y.domain([0, d3.max(data, function(d) { return d.count; })]);

    svg.append("g")
      .attr("class", "x commentChartAxis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

    svg.append("g")
      .attr("class", "y commentChartAxis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Value");

    var totalDaysInDomain = d3.time.days(x_domain[0], x_domain[1]);
    var barWidth = width / totalDaysInDomain.length;
    svg.selectAll(".bar")
        .data(data)
      .enter().append("rect")
        .attr("class", "commentChartBar")
        .attr("x", function(d) { return x(d.date); })
        .attr("width", barWidth)
        .attr("y", function(d) { return y(d.count); })
        .attr("height", function(d) { return height - y(d.count); })
       .append("svg:title")
        .text(function(d) { return d.date });
}

loadUserdataForUserIdentifier(userIdentifier, function onLoad() {
    updateViewFromUserdata();
});

</script>
</body>